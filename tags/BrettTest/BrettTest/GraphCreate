/*
 * 
 * 
 */
package jung1;


import edu.uci.ics.jung.algorithms.layout.BalloonLayout;
import edu.uci.ics.jung.algorithms.layout.TreeLayout;
import edu.uci.ics.jung.algorithms.layout.util.Relaxer;
import edu.uci.ics.jung.graph.DelegateForest;
import edu.uci.ics.jung.graph.DelegateTree;
import edu.uci.ics.jung.graph.DirectedGraph;
import edu.uci.ics.jung.graph.DirectedSparseMultigraph;
import edu.uci.ics.jung.graph.Forest;
import edu.uci.ics.jung.graph.Tree;
import edu.uci.ics.jung.visualization.GraphZoomScrollPane;
import edu.uci.ics.jung.visualization.Layer;
import edu.uci.ics.jung.visualization.VisualizationServer;
import edu.uci.ics.jung.visualization.VisualizationViewer;
import edu.uci.ics.jung.visualization.control.CrossoverScalingControl;
import edu.uci.ics.jung.visualization.control.DefaultModalGraphMouse;
import edu.uci.ics.jung.visualization.control.ModalGraphMouse;
import edu.uci.ics.jung.visualization.control.ScalingControl;
import edu.uci.ics.jung.visualization.decorators.EdgeShape;
import edu.uci.ics.jung.visualization.decorators.ToStringLabeller;
import edu.uci.ics.jung.visualization.layout.LayoutTransition;
import edu.uci.ics.jung.visualization.picking.PickedState;
import edu.uci.ics.jung.visualization.transform.MutableTransformer;
import edu.uci.ics.jung.visualization.transform.MutableTransformerDecorator;
import edu.uci.ics.jung.visualization.util.Animator;
import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Container;
import java.awt.Dimension;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.GridLayout;
import java.awt.Shape;
import java.awt.Toolkit;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.awt.geom.AffineTransform;
import java.awt.geom.Ellipse2D;
import java.awt.geom.Point2D;
import java.awt.image.BufferedImage;
import java.io.*;
import java.util.Map;
import javax.imageio.ImageIO;
import javax.swing.*;
import org.apache.commons.collections15.Factory;
import org.apache.commons.collections15.functors.ConstantTransformer;

/**
 *
 * @author Brett
 */
public class GraphCreate extends JApplet{
    //temporary testing strings
        String ID = "A0";
        String MAC = "192.168.1.1";

        
  Forest<String,Integer> graph;

  Factory<DirectedGraph<String,Integer>> graphFactory = 
    new Factory<DirectedGraph<String,Integer>>() {

        @Override
    public DirectedGraph<String, Integer> create() {
      return new DirectedSparseMultigraph<>();
    }
  };

  Factory<Tree<String,Integer>> treeFactory =
    new Factory<Tree<String,Integer>> () {

        @Override
    public Tree<String, Integer> create() {
      return new DelegateTree<>(graphFactory);
    }};
        

  Factory<Integer> edgeFactory = new Factory<Integer>() {
    int i=0;
      @Override
    public Integer create() {
      return i++;
    }};
   
  Factory<String> vertexFactory = new Factory<String>() {
    int i=0;
      @Override
    public String create() {
      return "V"+i++;
    }};

    /**
     * the visual component and renderer for the graph
     */
    VisualizationViewer<String,Integer> vv;
    
    VisualizationServer.Paintable rings;
    
    String root;
    
    TreeLayout<String,Integer> layout;
    
    BalloonLayout<String,Integer> radialLayout;
    /**
     * provides a Hyperbolic lens for the view
     */
    //LensSupport hyperbolicViewSupport;
//    private String vertex;
    
 //   static public Insets getScreenInsets(Window wnd){
 //       
 //   }
    
    public GraphCreate(final Map<String, NodeData> NodeTable, Map<String, EdgeData> EdgeTable) {
        
        // create a simple graph for the demo
        graph = new DelegateForest<>();

        createTree(NodeTable, EdgeTable);
        
        layout = new TreeLayout<>(graph);
        radialLayout = new BalloonLayout<>(graph);
        radialLayout.setSize(new Dimension(2000,2000));
        //Testing Screen insets

        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();
 
        vv =  new VisualizationViewer<>(layout, new Dimension(screenSize.width - 40,screenSize.height - 175));
        vv.setBackground(Color.white);
        vv.getRenderContext().setEdgeShapeTransformer(new EdgeShape.Line());
        vv.getRenderContext().setVertexLabelTransformer(new ToStringLabeller());
        // add a listener for ToolTips
        vv.setVertexToolTipTransformer(new ToStringLabeller());
        vv.getRenderContext().setArrowFillPaintTransformer(new ConstantTransformer(Color.lightGray));
        rings = new GraphCreate.Rings(radialLayout);
        
        Container content = getContentPane();
        final GraphZoomScrollPane panel = new GraphZoomScrollPane(vv);
        content.add(panel);
       
        
        final DefaultModalGraphMouse graphMouse = new DefaultModalGraphMouse();
//editing - final DefaultModalGraphMouse graphMouse = new DefaultModalGraphMouse(vv.getRenderContext(), vertexFactory, edgeFactory);

        vv.setGraphMouse(graphMouse);
        vv.addKeyListener(graphMouse.getModeKeyListener());
        
/* hyperbolic view waste        
        hyperbolicViewSupport = 
            new ViewLensSupport<>(vv, new HyperbolicShapeTransformer(vv, 
                vv.getRenderContext().getMultiLayerTransformer().getTransformer(Layer.VIEW)), 
                    new ModalLensGraphMouse());

        graphMouse.addItemListener(hyperbolicViewSupport.getGraphMouse().getModeListener());
*/
        
        JComboBox modeBox = graphMouse.getModeComboBox();
        //annotation doesn't work well when flipping graph modes
//        modeBox.removeItemAt(3);
//        modeBox.removeItemAt
        //end annotation removal
        modeBox.addItemListener(graphMouse.getModeListener());
        graphMouse.setMode(ModalGraphMouse.Mode.TRANSFORMING);

        final ScalingControl scaler = new CrossoverScalingControl();
        
        vv.scaleToLayout(scaler);

        JButton plus = new JButton("+");
        plus.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                scaler.scale(vv, 1.1f, vv.getCenter());
            }
        });
        JButton minus = new JButton("-");
        minus.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                scaler.scale(vv, 1/1.1f, vv.getCenter());
            }
        });
        
        JButton imgSave = new JButton("Save .jpg");
        imgSave.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                //img dimensions
                int width = vv.getWidth();
                int height = vv.getHeight();
                
                //File dialog
                JFrame saveFrame = new JFrame();
                JFileChooser fileImg = new JFileChooser(".");
                int saveChoice = fileImg.showSaveDialog(saveFrame);
                File selectedFile;
                
                //If save then get selected file name
                if (saveChoice == JFileChooser.APPROVE_OPTION)
                {
                    selectedFile = fileImg.getSelectedFile();
                }
                else 
                {
                    selectedFile = null;
                }
               
                //Create img
                BufferedImage bi = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
                Graphics2D graphics = bi.createGraphics();
                vv.paint(graphics);
                graphics.dispose();
                
                //Write img at the location
                try
                {
                    ImageIO.write(bi, "jpg", selectedFile);                    
                }
                catch(Exception ee)
                {
                    JFrame notification = new JFrame();
                    JOptionPane.showMessageDialog(notification,"Error writing/creating image");
                }
                vv.setDoubleBuffered(true);
            }
        });
        
        JButton resetGrid = new JButton("Reset Cam");
        resetGrid.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                //reset zoom               
                vv.getRenderContext().getMultiLayerTransformer().getTransformer(Layer.LAYOUT).setToIdentity();
                vv.getRenderContext().getMultiLayerTransformer().getTransformer(Layer.VIEW).setToIdentity();
                
                //reset Camera
                //TreeLayout<String, Integer> Treelayout = vv.getGraphLayout();
                layout.initialize();
                Relaxer relaxer = vv.getModel().getRelaxer();
                if(relaxer != null) 
                {
                    relaxer.stop();
                    relaxer.prerelax();
                    relaxer.relax();
                } 
            }
        });
        
        JToggleButton radial = new JToggleButton("Balloon");
        radial.addItemListener(new ItemListener() {

            @Override
      public void itemStateChanged(ItemEvent e) {
        if(e.getStateChange() == ItemEvent.SELECTED) {

          LayoutTransition<String,Integer> lt =
            new LayoutTransition<>(vv, layout, radialLayout);
          Animator animator = new Animator(lt);
          animator.start();
          vv.getRenderContext().getMultiLayerTransformer().getTransformer(Layer.LAYOUT).setToIdentity();
          vv.addPreRenderPaintable(rings);
        } else {

          LayoutTransition<String,Integer> lt =
            new LayoutTransition<>(vv, radialLayout, layout);
          Animator animator = new Animator(lt);
          animator.start();
          vv.getRenderContext().getMultiLayerTransformer().getTransformer(Layer.LAYOUT).setToIdentity();
          vv.removePreRenderPaintable(rings);
        }
        vv.repaint();
      }});

        JPanel scaleGrid = new JPanel(new GridLayout(1,0));
        scaleGrid.setBorder(BorderFactory.createTitledBorder("Zoom"));

        JPanel controls = new JPanel();
        scaleGrid.add(plus);
        scaleGrid.add(minus);
        controls.add(radial);
        controls.add(resetGrid);
        controls.add(scaleGrid);
        controls.add(modeBox);
                       
        
        final JTextArea tf = new JTextArea();
        tf.setColumns(24);
        tf.setRows(3);
        tf.setEditable(false);
        
        controls.add(tf);
        controls.add(imgSave);
        

        final PickedState<String> pickedState = vv.getPickedVertexState();
        pickedState.addItemListener(new ItemListener() 
        {
            @Override
            public void itemStateChanged(ItemEvent e) 
            {
                Object subject = e.getItem();
                if (subject instanceof String) 
                {
                    String vertex = (String) subject;
                    //pickedState.isPicked(vertex);
                    if (pickedState.isPicked(vertex)) 
                    {
                        System.out.println("Vertex " + vertex + " is now selected");
                        
                        //      Testing stuff
                        for(Integer i = 1; NodeTable.get("node" + i) != null;)
                        {

                            //string.valueof(int);
                            if(NodeTable.get("node" + i).getName().compareTo(vertex) == 0)
                            {
                            System.out.println("Found Match: " + NodeTable.get("node" + i).getName() + "  compared to:  " + vertex);                                
                            vertex = "node" + i;
                            }
                            i++;
                        }
                        tf.setText("Node name: " + NodeTable.get(vertex).getName() + "\n");
                        tf.append(NodeTable.get(vertex).getF1() + "\n");
                        tf.append(NodeTable.get(vertex).getF2() + "\n");
                        tf.append(NodeTable.get(vertex).getF3() + "\n");
                    } 
                    else 
                    {
                        System.out.println("Vertex " + vertex + " no longer selected");
                    }
                }
            }    
        });
        

       

       
        content.add(controls, BorderLayout.SOUTH);
    }
        
    
        
    class Rings implements VisualizationServer.Paintable {
      
      BalloonLayout<String,Integer> layout;
      
      public Rings(BalloonLayout<String,Integer> layout) {
        this.layout = layout;
      }
        @Override
    public void paint(Graphics g) {
      g.setColor(Color.gray);
    
      Graphics2D g2d = (Graphics2D)g;

      Ellipse2D ellipse = new Ellipse2D.Double();
      for(String v : layout.getGraph().getVertices()) {
        Double radius = layout.getRadii().get(v);
        if(radius == null) {
              continue;
        }
        Point2D p = layout.transform(v);
        ellipse.setFrame(-radius, -radius, 2*radius, 2*radius);
        AffineTransform at = AffineTransform.getTranslateInstance(p.getX(), p.getY());
        Shape shape = at.createTransformedShape(ellipse);
        
        MutableTransformer viewTransformer =
          vv.getRenderContext().getMultiLayerTransformer().getTransformer(Layer.VIEW);
        
        if(viewTransformer instanceof MutableTransformerDecorator) {
          shape = vv.getRenderContext().getMultiLayerTransformer().transform(shape);
        } else {
          shape = vv.getRenderContext().getMultiLayerTransformer().transform(Layer.LAYOUT,shape);
        }

        g2d.draw(shape);
      }
    }

        @Override
    public boolean useTransform() {
      return true;
    }
    }      
    
        private void createTree(Map<String, NodeData> NodeTable, Map<String, EdgeData> EdgeTable) {
        //mandatory server main vertex    
//        graph.addVertex("proton");
/*      
 * 
 *  Makes all the vertex's then all the edges. 
 */
        String HashID = "node";
        String EdgeID = "edge";
        Integer count = 1;
        String newNode;
        
        //testing string
//        System.out.println(HashID + count);
//        System.out.println(NodeTable.toString());
//        System.out.println(EdgeTable.toString());
        
        while(NodeTable.get(HashID + count) != null) {            
            newNode = NodeTable.get(HashID + count).getName();
            System.out.println(newNode + " has been drawn");
            count++;
            graph.addVertex(newNode);
        }
        count = 1;

        //more testing woulnd't draw edges
//        graph.addEdge(edgeFactory.create(), "proton", "node1");
//        graph.addEdge(edgeFactory.create(), "proton", "node2");
//        graph.addEdge(edgeFactory.create(), "proton", "node3");
        while(EdgeTable.get(EdgeID + count) != null){
            System.out.println(EdgeTable.get(EdgeID + count).getParent() + " is connected to " + EdgeTable.get(EdgeID + count).getChild());
            graph.addEdge(edgeFactory.create(), EdgeTable.get(EdgeID + count).getParent(), EdgeTable.get(EdgeID + count).getChild());
            count++;
        }


/*
        graph.addVertex("A0");
        graph.addEdge(edgeFactory.create(), "server", "A4");
*/        
   }       
        
}
